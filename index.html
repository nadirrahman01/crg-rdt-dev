<!-- index.html -->
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>CRG - Research Documentation Tool</title>

  <!-- Institutional stylesheet -->
  <link rel="stylesheet" href="assets/styles.css">

  <!-- Chart.js (price chart) -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
</head>

<body>
  <div class="app">

    <!-- Topbar (old-school institutional) -->
    <header class="topbar">
      <div class="topbar-left">
        <div class="brand">
          <div class="brand-line1">CORDOBA RESEARCH GROUP</div>
          <div class="brand-line2">Research Documentation Tool (RDT)</div>
        </div>

        <div class="topbar-meta">
          <div class="meta-item"><span class="meta-label">Document control:</span> Internal system output</div>
          <div class="meta-item"><span class="meta-label">Version:</span> <strong id="versionText">v1.0</strong></div>
          <div class="meta-item"><span class="meta-label">Status:</span> <strong id="statusTextMirror">Draft</strong></div>
        </div>
      </div>

      <div class="topbar-right">
        <button type="button" id="jumpMissingBtn" class="btn btn-quiet">Jump to first missing</button>
        <button type="button" id="clearAutosaveBtn" class="btn btn-quiet">Clear autosave</button>
      </div>
    </header>

    <div class="main">

      <!-- Left rail -->
      <aside class="rail">
        <div class="rail-block">
          <div class="rail-title">Completion</div>

          <div class="rail-kpi">
            <span id="completionText">0 / 0 required</span>
            <span class="muted" id="completionPct"></span>
          </div>

          <div class="rail-bar" role="progressbar" aria-valuemin="0" aria-valuemax="100" aria-valuenow="0">
            <div class="rail-bar-fill" id="completionBar"></div>
          </div>

          <div class="rail-mini">
            <div class="rail-mini-title">Navigation</div>
            <ol class="rail-steps">
              <li><a class="rail-link" href="#sec-setup">1. Setup</a></li>
              <li><a class="rail-link" href="#sec-authors">2. Authors</a></li>
              <li><a class="rail-link" href="#sec-core">3. Core research</a></li>
              <li id="equityRailLink"><a class="rail-link" href="#sec-equity">4. Equity module</a></li>
              <li><a class="rail-link" href="#sec-figures">5. Figures</a></li>
              <li><a class="rail-link" href="#sec-review">6. Review & export</a></li>
            </ol>
          </div>
        </div>

        <div class="rail-block">
          <div class="rail-title">Analyst prompts</div>
          <ul class="rail-bullets">
            <li>Write a thesis that can be quoted.</li>
            <li>Anchor numbers to a source and date.</li>
            <li>State disconfirmers (what would prove you wrong).</li>
            <li>Keep “Cordoba view” tradeable and conditional.</li>
          </ul>
        </div>

        <div class="rail-block">
          <div class="rail-title">Data note</div>
          <div class="rail-help">
            Equity chart fetch uses Stooq daily closes via proxy. Confirm symbols on stooq.com.
            Examples: MSFT.US, VOD.UK, BMW.DE.
          </div>
        </div>
      </aside>

      <!-- Main canvas -->
      <main class="canvas">

        <form id="researchForm" novalidate>

          <!-- =========================
               1) Setup
               ========================= -->
          <section id="sec-setup" class="card">
            <div class="card-head">
              <div>
                <div class="card-title">1) Note setup</div>
                <div class="card-subtitle">Template, distribution preset, workflow status, versioning, and change note.</div>
              </div>
            </div>

            <div class="grid-2">
              <div>
                <label for="noteTemplate">Template</label>
                <select id="noteTemplate">
                  <option value="">Select template…</option>
                  <option value="Macro update">Macro update</option>
                  <option value="Equity initiation">Equity initiation</option>
                  <option value="Event note">Event note</option>
                </select>
                <div class="hint">Templates prefill fields if blank and adjust structure.</div>
              </div>

              <div>
                <label for="noteType">Type of note</label>
                <select id="noteType" required>
                  <option value="">Select note type…</option>
                  <option value="General Note">General Note</option>
                  <option value="Equity Research">Equity Research</option>
                  <option value="Macro Research">Macro Research</option>
                  <option value="Fixed Income Research">Fixed Income Research</option>
                  <option value="Commodity Insights">Commodity Insights</option>
                </select>
                <div class="hint">Controls modules and routing logic.</div>
              </div>
            </div>

            <div class="grid-2">
              <div>
                <label for="distributionPreset">Distribution preset</label>
                <select id="distributionPreset" required>
                  <option value="Internal only" selected>Internal only</option>
                  <option value="Public pack">Public pack</option>
                  <option value="Client-safe">Client-safe</option>
                </select>
                <div class="hint">Client-safe requires Status = Cleared. Presets control watermarking, redactions, and routing.</div>
              </div>

              <div>
                <label for="workflowStatus">Status</label>
                <select id="workflowStatus" required>
                  <option value="Draft" selected>Draft</option>
                  <option value="Reviewed">Reviewed</option>
                  <option value="Cleared">Cleared</option>
                </select>
                <div class="hint">Draft exports are watermarked. Reviewed/Cleared remove watermark.</div>
              </div>
            </div>

            <div class="grid-2">
              <div>
                <label for="reviewedBy">Reviewed by</label>
                <select id="reviewedBy">
                  <option value="">Select reviewer…</option>
                  <option value="Tim">Tim</option>
                  <option value="Tommaso">Tommaso</option>
                  <option value="Uhayd">Uhayd</option>
                  <option value="Nadir">Nadir</option>
                </select>
                <div class="hint">Required when Status is Reviewed or Cleared.</div>
              </div>

              <div>
                <label for="changeNote">Change note <span class="muted">(optional)</span></label>
                <textarea id="changeNote" rows="3" placeholder="e.g., Updated valuation post earnings; revised WACC."></textarea>
                <div class="hint">Included in Word header (Internal only preset) and email subject marker.</div>
              </div>
            </div>

            <div class="grid-1">
              <label for="topic">Topic</label>
              <input type="text" id="topic" required placeholder="e.g., UK inflation dynamics, Vietnam consumer, uranium supply chain…">
              <div class="hint">Short descriptor used in document header block.</div>

              <label for="title" style="margin-top:10px;">Title</label>
              <input type="text" id="title" required placeholder="Enter research title…">
              <div class="hint">Institutional: angle-first, investor-led phrasing.</div>
            </div>
          </section>

          <!-- =========================
               2) Authors
               ========================= -->
          <section id="sec-authors" class="card">
            <div class="card-head">
              <div>
                <div class="card-title">2) Authors</div>
                <div class="card-subtitle">Primary author and co-authors (optional).</div>
              </div>
            </div>

            <div class="grid-2">
              <div>
                <label for="authorLastName">Primary author — last name</label>
                <input type="text" id="authorLastName" required placeholder="e.g., Rahman">
              </div>
              <div>
                <label for="authorFirstName">Primary author — first name</label>
                <input type="text" id="authorFirstName" required placeholder="e.g., Nadir">
              </div>
            </div>

            <div class="grid-1">
              <label for="authorPhoneNational">Primary author — phone <span class="muted">(optional)</span></label>
              <div class="phone-row" id="authorPhoneRow">
                <select id="authorPhoneCountry" class="phone-country" aria-label="Country code">
                  <option value="44" selected>+44</option>
                  <option value="1">+1</option>
                  <option value="353">+353</option>
                  <option value="33">+33</option>
                  <option value="49">+49</option>
                  <option value="31">+31</option>
                  <option value="34">+34</option>
                  <option value="39">+39</option>
                  <option value="971">+971</option>
                  <option value="966">+966</option>
                  <option value="92">+92</option>
                  <option value="880">+880</option>
                  <option value="91">+91</option>
                  <option value="234">+234</option>
                  <option value="254">+254</option>
                  <option value="27">+27</option>
                  <option value="995">+995</option>
                  <option value="">Other</option>
                </select>
                <input type="text" id="authorPhoneNational" class="phone-number" inputmode="numeric" autocomplete="tel-national" placeholder="e.g., 7323 324 120">
              </div>

              <!-- hidden source-of-truth (used by JS + Word export) -->
              <input type="text" id="authorPhone" style="display:none;">
              <div class="hint">Stored as CC-NUMBER (digits only). Display formatting does not affect export.</div>
            </div>

            <div class="grid-1">
              <div class="coauthor-head">
                <div class="coauthor-title">Co-authors <span class="muted">(optional)</span></div>
                <button type="button" id="addCoAuthor" class="btn">Add co-author</button>
              </div>
              <div id="coAuthorsList"></div>
            </div>
          </section>

          <!-- =========================
               3) Core research
               ========================= -->
          <section id="sec-core" class="card">
            <div class="card-head">
              <div>
                <div class="card-title">3) Core research</div>
                <div class="card-subtitle">Thesis, executive summary (optional), takeaways, analysis, and Cordoba view.</div>
              </div>
            </div>

            <div class="grid-1">
              <div class="field-head">
                <label for="thesis">Thesis</label>
                <div class="field-metrics"><span id="thesisCount">0</span> words</div>
              </div>
              <textarea id="thesis" rows="3" required placeholder="1–2 lines: what changed, what’s priced, what’s mispriced."></textarea>
              <div class="hint">Write something a PM could quote back to you.</div>

              <div class="toggle-row">
                <input type="checkbox" id="autoExecSummary">
                <label for="autoExecSummary" class="toggle-label">Auto-generate Executive Summary (editable)</label>
              </div>

              <div class="field-head">
                <label for="execSummary">Executive Summary <span class="muted">(optional)</span></label>
                <div class="field-metrics"><span id="execCount">0</span> words</div>
              </div>
              <textarea id="execSummary" rows="6" placeholder="If auto-toggle is on, this will be generated and you can edit it."></textarea>
              <div class="hint">Front-loaded page: thesis + first takeaway + rating/target (if relevant).</div>

              <div class="field-head">
                <label for="keyTakeaways">Key takeaways</label>
                <div class="field-metrics"><span id="takeawayCount">0</span> words</div>
              </div>
              <textarea id="keyTakeaways" rows="6" required placeholder="Use bullet points with - or * …"></textarea>

              <div class="field-head">
                <label for="analysis">Analysis and commentary</label>
                <div class="field-metrics"><span id="analysisCount">0</span> words</div>
              </div>
              <textarea id="analysis" rows="10" required placeholder="Thesis → evidence → transmission → risks → positioning."></textarea>

              <label for="content">Additional content <span class="muted">(optional)</span></label>
              <textarea id="content" rows="7" placeholder="Appendices, deeper detail, background context…"></textarea>

              <div class="field-head">
                <label for="cordobaView">The Cordoba view</label>
                <div class="field-metrics"><span id="cvCount">0</span> words</div>
              </div>
              <textarea id="cordobaView" rows="6" required placeholder="Your stance, what you’d do, and conditions for change."></textarea>
            </div>
          </section>

          <!-- =========================
               4) Equity module (conditional)
               ========================= -->
          <section id="sec-equity" class="card" style="display:none;">
            <div class="card-head">
              <div>
                <div class="card-title">4) Equity module</div>
                <div class="card-subtitle">Rating, target, chart, source attribution, scenarios, and model attachments.</div>
              </div>
            </div>

            <div class="grid-2">
              <div>
                <label for="ticker">Ticker / Company <span class="muted">(optional)</span></label>
                <input type="text" id="ticker" placeholder="e.g., MSFT.US or VOD.UK">
              </div>
              <div>
                <label for="crgRating">CRG Rating</label>
                <select id="crgRating" required>
                  <option value="">Select rating…</option>
                  <option value="Outperform (O)">Outperform (O)</option>
                  <option value="Sector Perform (SP)">Sector Perform (SP)</option>
                  <option value="Underperform (U)">Underperform (U)</option>
                  <option value="Restricted (R)">Restricted (R)</option>
                  <option value="Not Rated (NR)">Not Rated (NR)</option>
                </select>
              </div>
            </div>

            <div class="grid-2">
              <div>
                <label for="targetPrice">Target price</label>
                <input type="text" id="targetPrice" required placeholder="e.g., 520">
              </div>
              <div>
                <label for="priceDataSource">Data source</label>
                <select id="priceDataSource">
                  <option value="Stooq (via proxy)" selected>Stooq (via proxy)</option>
                  <option value="Bloomberg">Bloomberg</option>
                  <option value="Company filings">Company filings</option>
                  <option value="Internal model">Internal model</option>
                </select>
              </div>
            </div>

            <div class="grid-1 chart-panel">
              <div class="chart-row">
                <div><strong>Price chart</strong> <span class="muted">(fetch embeds chart into Word)</span></div>
                <div class="chart-controls">
                  <label class="inline-label" for="chartRange">Range</label>
                  <select id="chartRange" class="inline-select">
                    <option value="6mo" selected>6M</option>
                    <option value="1y">1Y</option>
                    <option value="2y">2Y</option>
                    <option value="5y">5Y</option>
                  </select>
                  <button type="button" id="fetchPriceChart" class="btn">Fetch</button>
                </div>
              </div>

              <div id="chartStatus" class="hint"></div>
              <div class="chart-wrap">
                <canvas id="priceChart"></canvas>
              </div>

              <label for="chartAnnotation">Chart annotation <span class="muted">(optional)</span></label>
              <textarea id="chartAnnotation" rows="3" placeholder="e.g., Note: spike reflects post-earnings repricing."></textarea>

              <div class="metrics-grid">
                <div class="metric"><div class="metric-label">Current Price</div><div class="metric-value" id="currentPrice">—</div></div>
                <div class="metric"><div class="metric-label">Volatility (ann.)</div><div class="metric-value" id="realisedVol">—</div></div>
                <div class="metric"><div class="metric-label">Return (range)</div><div class="metric-value" id="rangeReturn">—</div></div>
                <div class="metric"><div class="metric-label">Upside to Target</div><div class="metric-value" id="upsideToTarget">—</div></div>
              </div>
            </div>

            <div class="card-subhead">Scenarios (Bear / Base / Bull)</div>
            <div class="grid-2">
              <div>
                <label for="scenarioBearPrice">Bear price</label>
                <input type="text" id="scenarioBearPrice" placeholder="e.g., 380">
                <label for="scenarioBearKey" style="margin-top:8px;">Bear key assumption</label>
                <input type="text" id="scenarioBearKey" placeholder="e.g., margins compress, weaker demand">
              </div>
              <div>
                <label for="scenarioBasePrice">Base price</label>
                <input type="text" id="scenarioBasePrice" placeholder="e.g., 520">
                <label for="scenarioBaseKey" style="margin-top:8px;">Base key assumption</label>
                <input type="text" id="scenarioBaseKey" placeholder="e.g., steady growth, stable margins">
              </div>
            </div>
            <div class="grid-2" style="padding-top:0;">
              <div>
                <label for="scenarioBullPrice">Bull price</label>
                <input type="text" id="scenarioBullPrice" placeholder="e.g., 680">
                <label for="scenarioBullKey" style="margin-top:8px;">Bull key assumption</label>
                <input type="text" id="scenarioBullKey" placeholder="e.g., multiple expansion, upside surprise">
              </div>
              <div></div>
            </div>

            <div class="card-subhead">Model & valuation</div>
            <div class="grid-1">
              <label for="modelFiles">Upload model files (Excel / PDF)</label>
              <input type="file" id="modelFiles" multiple accept=".xlsx,.xlsm,.xls,.csv,application/pdf" required>

              <div class="attach-strip" id="attachmentSummary" aria-live="polite">
                <div id="attachmentSummaryHead">No files selected</div>
                <div id="attachmentSummaryList" style="display:none;"></div>
              </div>

              <label for="modelLink">Model link <span class="muted">(optional)</span></label>
              <input type="text" id="modelLink" placeholder="Drive / SharePoint link">

              <label for="valuationSummary">Valuation summary <span class="muted">(optional)</span></label>
              <textarea id="valuationSummary" rows="5"></textarea>

              <label for="keyAssumptions">Key assumptions <span class="muted">(optional)</span></label>
              <textarea id="keyAssumptions" rows="6"></textarea>

              <label for="scenarioNotes">Scenario / sensitivity notes <span class="muted">(optional)</span></label>
              <textarea id="scenarioNotes" rows="5"></textarea>
            </div>
          </section>

          <!-- =========================
               5) Figures
               ========================= -->
          <section id="sec-figures" class="card">
            <div class="card-head">
              <div>
                <div class="card-title">5) Figures & attachments</div>
                <div class="card-subtitle">Images are embedded at the end. Filenames become captions.</div>
              </div>
            </div>

            <div class="grid-1">
              <label for="imageUpload">Upload images / graphs <span class="muted">(optional)</span></label>
              <input type="file" id="imageUpload" multiple accept="image/*">
              <div class="hint">In the narrative, refer to “Figure 1 / Figure 2 …”</div>
            </div>
          </section>

          <!-- =========================
               6) Review & export
               ========================= -->
          <section id="sec-review" class="card">
            <div class="card-head">
              <div>
                <div class="card-title">6) Review & export</div>
                <div class="card-subtitle">Compliance acknowledgement, gating, and export routing.</div>
              </div>
            </div>

            <div class="review-grid">
              <div class="review-block">
                <div class="review-title">Pre-flight checklist</div>
                <ul class="review-list">
                  <li>Title matches thesis (no drift).</li>
                  <li>Takeaways are decision-useful.</li>
                  <li>Risks / disconfirmers included.</li>
                  <li>Data sources are stated for key numbers.</li>
                  <li>Equity: rating/target consistent with narrative.</li>
                </ul>
              </div>

              <div class="review-block">
                <div class="review-title">Compliance</div>

                <div class="checkline">
                  <input type="checkbox" id="complianceAck">
                  <div>
                    <div><strong>I confirm I will verify figures, tickers, and assumptions before distribution.</strong></div>
                    <div class="hint">Export blocked until checked. Draft exports are watermarked.</div>
                  </div>
                </div>

                <div class="review-title" style="margin-top:12px;">Validation summary</div>
                <div class="hint" id="validationSummary">Complete required fields to enable export.</div>
              </div>
            </div>

            <div class="actions">
              <button type="button" id="emailToCrgBtn" class="btn">Email to CRG Research</button>
              <button type="button" id="resetFormBtn" class="btn">Reset</button>
              <button type="submit" class="btn btn-primary">Generate Word Document</button>
            </div>

            <div id="message" class="message"></div>

            <div class="footerline">
              <div>Internal use only • outputs generated from user inputs and referenced data sources</div>
              <div>CRG RDT</div>
            </div>
          </section>

        </form>
      </main>
    </div>
  </div>

  <!-- Docx + FileSaver (Word export) -->
  <script src="https://unpkg.com/docx@7.8.2/build/index.js"></script>
  <script src="https://unpkg.com/file-saver@2.0.5/dist/FileSaver.min.js"></script>

  <!-- App JS -->
  <script src="assets/app.js"></script>

  <!-- Small UI helpers (word count + status mirror) -->
  <script>
    function wordCount(text){
      return (text || "").trim().split(/\s+/).filter(Boolean).length;
    }
    function bindCount(inputId, outId){
      const el = document.getElementById(inputId);
      const out = document.getElementById(outId);
      if (!el || !out) return;
      const paint = () => out.textContent = String(wordCount(el.value));
      el.addEventListener("input", paint);
      paint();
    }

    bindCount("thesis","thesisCount");
    bindCount("execSummary","execCount");
    bindCount("keyTakeaways","takeawayCount");
    bindCount("analysis","analysisCount");
    bindCount("cordobaView","cvCount");

    // Mirror workflow status in topbar
    const statusEl = document.getElementById("workflowStatus");
    const mirror = document.getElementById("statusTextMirror");
    function paintStatus(){ if (statusEl && mirror) mirror.textContent = statusEl.value; }
    if (statusEl) statusEl.addEventListener("change", paintStatus);
    paintStatus();
  </script>
</body>
</html>
