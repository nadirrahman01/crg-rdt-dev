<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>CRG â€” Research Documentation Tool</title>
  <link rel="stylesheet" href="assets/styles.css">

  <!-- Chart.js (for price chart) -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

  <!-- Minimal safe inline: layout only (your CSS will take over later) -->
  <style>
    .app-shell{ display:flex; gap: 18px; align-items: flex-start; }
    .app-nav{ width: 290px; position: sticky; top: 18px; }
    .app-main{ flex: 1; min-width: 0; }
    @media (max-width: 980px){
      .app-shell{ flex-direction: column; }
      .app-nav{ width: 100%; position: relative; top: 0; }
    }
  </style>
</head>

<body>
  <div class="container container-pad-bottom">

    <!-- Top header (institutional) -->
    <header class="app-topbar">
      <div class="topbar-left">
        <div class="brand-lockup">
          <!-- Optional: drop a logo later -->
          <div class="brand-mark" aria-hidden="true">CRG</div>
          <div class="brand-text">
            <div class="brand-title">Research Documentation Tool</div>
            <div class="brand-subtitle">Internal research note builder Â· auditable outputs Â· consistent formatting</div>
          </div>
        </div>
      </div>

      <div class="topbar-right">
        <div class="topbar-meta">
          <div class="meta-pill" id="autoSaveStatus">Autosave: â€”</div>
          <div class="meta-pill" id="sessionClock">Session: â€”</div>
        </div>
      </div>
    </header>

    <div class="app-shell">

      <!-- Left nav / workflow -->
      <aside class="app-nav">
        <div class="nav-card">
          <div class="nav-card-title">Workflow</div>

          <!-- Completion meter -->
          <div class="progress-wrap" aria-label="Completion meter">
            <div class="progress-label">
              Completion: <span id="completionText">0 / 8 core fields</span>
            </div>
            <div class="progress-bar" role="progressbar" aria-valuemin="0" aria-valuemax="100" aria-valuenow="0">
              <div class="progress-fill" id="completionBar" style="width:0%"></div>
            </div>
          </div>

          <!-- Nav links -->
          <nav class="nav-list" aria-label="Section navigation">
            <a class="nav-item" href="#sec-metadata">1) Note Setup</a>
            <a class="nav-item" href="#sec-authors">2) Authors</a>
            <a class="nav-item" href="#sec-equity" id="navEquityLink" style="display:none;">3) Equity Pack</a>
            <a class="nav-item" href="#sec-core">4) Core Research</a>
            <a class="nav-item" href="#sec-attachments">5) Figures & Attachments</a>
            <a class="nav-item" href="#sec-review">6) Review & Export</a>
          </nav>

          <!-- Quality prompts -->
          <div class="nav-quality">
            <div class="nav-quality-title">Quality prompts</div>
            <ul class="nav-quality-list">
              <li>State the thesis in 1 line.</li>
              <li>Anchor claims to data or a clear assumption.</li>
              <li>Call out what would change your view.</li>
              <li>Make the output auditable (figures + links).</li>
            </ul>
          </div>

          <!-- Quick actions -->
          <div class="nav-actions">
            <button type="button" class="btn btn-secondary" id="jumpToFirstMissing">Jump to first missing</button>
            <button type="button" class="btn btn-secondary" id="clearAutosaveBtn">Clear autosave</button>
          </div>
        </div>

        <div class="nav-card nav-card--secondary">
          <div class="nav-card-title">Help</div>
          <div class="tool-info-text">
            This tool pulls price data using <strong>Stooq symbols</strong> (via proxy).
            For US equities: <strong>MSFT.US</strong> or <strong>MSFT</strong>. For UK/LSE: <strong>VOD.UK</strong>, <strong>BP.UK</strong>, <strong>HSBA.UK</strong>.
            Confirm symbols on
            <a href="https://stooq.com/" target="_blank" rel="noopener noreferrer">stooq.com</a>.
          </div>
        </div>
      </aside>

      <!-- Main content -->
      <main class="app-main">

        <form id="researchForm" novalidate>

          <!-- SECTION 1: Metadata -->
          <section class="sec" id="sec-metadata" data-section="metadata">
            <div class="sec-head">
              <div class="sec-title">1) Note setup</div>
              <div class="sec-subtitle">Define note type, title and topic. This drives formatting and routing.</div>
            </div>

            <div class="grid-2">
              <div class="field">
                <label for="noteType">Type of Note</label>
                <select id="noteType" required>
                  <option value="">Select note type...</option>
                  <option value="General Note">General Note</option>
                  <option value="Equity Research">Equity Research</option>
                  <option value="Macro Research">Macro Research</option>
                  <option value="Fixed Income Research">Fixed Income Research</option>
                  <option value="Commodity Insights">Commodity Insights</option>
                </select>
                <div class="field-help">Tip: Choose the closest match â€” it controls which modules appear.</div>
              </div>

              <div class="field">
                <label for="topic">Topic</label>
                <input type="text" id="topic" required placeholder="e.g., UK inflation dynamics, Vietnam consumer, uranium supply chain...">
                <div class="field-help">Keep topic short. Title can be more descriptive.</div>
              </div>
            </div>

            <div class="field">
              <label for="title">Title</label>
              <input type="text" id="title" required placeholder="Enter research title...">
              <div class="field-help">Aim for a clear investor-led statement, not a blog headline.</div>
            </div>

            <div class="callout callout--info">
              <div class="callout-title">Institutional standard</div>
              <div class="callout-text">
                Write as if your PM will forward this to an IC pack: clean thesis, evidence, risks, and clear â€œCordoba Viewâ€.
              </div>
            </div>
          </section>

          <!-- SECTION 2: Authors -->
          <section class="sec" id="sec-authors" data-section="authors">
            <div class="sec-head">
              <div class="sec-title">2) Authors</div>
              <div class="sec-subtitle">Primary author + optional co-authors. Phone is optional but formatted consistently.</div>
            </div>

            <div class="grid-2">
              <div class="field">
                <label for="authorLastName">Primary Author â€” Last Name</label>
                <input type="text" id="authorLastName" required placeholder="e.g., Rahman">
              </div>

              <div class="field">
                <label for="authorFirstName">Primary Author â€” First Name</label>
                <input type="text" id="authorFirstName" required placeholder="e.g., Nadir">
              </div>
            </div>

            <div class="field">
              <label for="authorPhoneNational">Primary Author â€” Phone <span class="panel-muted">(Optional)</span></label>

              <div class="phone-row" id="authorPhoneRow">
                <select id="authorPhoneCountry" class="phone-country" aria-label="Country code">
                  <option value="44" selected>ğŸ‡¬ğŸ‡§ +44 (UK)</option>
                  <option value="1">ğŸ‡ºğŸ‡¸ +1 (US)</option>
                  <option value="353">ğŸ‡®ğŸ‡ª +353 (IE)</option>
                  <option value="33">ğŸ‡«ğŸ‡· +33 (FR)</option>
                  <option value="49">ğŸ‡©ğŸ‡ª +49 (DE)</option>
                  <option value="31">ğŸ‡³ğŸ‡± +31 (NL)</option>
                  <option value="34">ğŸ‡ªğŸ‡¸ +34 (ES)</option>
                  <option value="39">ğŸ‡®ğŸ‡¹ +39 (IT)</option>
                  <option value="971">ğŸ‡¦ğŸ‡ª +971 (AE)</option>
                  <option value="966">ğŸ‡¸ğŸ‡¦ +966 (SA)</option>
                  <option value="92">ğŸ‡µğŸ‡° +92 (PK)</option>
                  <option value="880">ğŸ‡§ğŸ‡© +880 (BD)</option>
                  <option value="91">ğŸ‡®ğŸ‡³ +91 (IN)</option>
                  <option value="234">ğŸ‡³ğŸ‡¬ +234 (NG)</option>
                  <option value="254">ğŸ‡°ğŸ‡ª +254 (KE)</option>
                  <option value="27">ğŸ‡¿ğŸ‡¦ +27 (ZA)</option>
                  <option value="995">ğŸ‡¬ğŸ‡ª +995 (GE)</option>
                  <option value="">Other</option>
                </select>

                <input
                  type="text"
                  id="authorPhoneNational"
                  class="phone-number"
                  inputmode="numeric"
                  autocomplete="tel-national"
                  placeholder="e.g., 7323 324 120"
                >
              </div>

              <!-- Keep hidden field for existing logic -->
              <input type="text" id="authorPhone" required placeholder="e.g., 44-7393454410" style="display:none;">
              <div class="field-help">Stored as <code>CC-NUMBER</code> (digits only). Display formatting wonâ€™t affect the export.</div>
            </div>

            <!-- Co-authors -->
            <div id="coAuthorsSection" class="panel">
              <div class="panel-head">
                <div class="panel-title">Co-Authors <span class="panel-muted">(Optional)</span></div>
                <button type="button" id="addCoAuthor" class="btn btn-secondary">+ Add Co-Author</button>
              </div>
              <div id="coAuthorsList"></div>
            </div>
          </section>

          <!-- SECTION 3: Equity -->
          <section class="sec" id="sec-equity" data-section="equity">
            <div id="equitySection" class="equity-section" style="display:none;">
              <div class="equity-header">
                <div class="equity-title">3) Equity pack</div>
                <div class="equity-subtitle">
                  Add ticker, rating, target, chart, model files, and valuation notes to keep the output investment-grade.
                </div>
              </div>

              <div class="grid-2">
                <div class="field">
                  <label for="ticker">Ticker / Company <span class="panel-muted">(Optional)</span></label>
                  <input type="text" id="ticker" placeholder="e.g., MSFT.US (US) or VOD.UK (UK/LSE)">
                  <div class="ticker-microtext">
                    Examples: <strong>MSFT.US</strong>, <strong>VOD.UK</strong>
                    <span class="ticker-dot">Â·</span>
                    <a class="ticker-link" href="https://stooq.com/" target="_blank" rel="noopener noreferrer">Open Stooq search</a>
                  </div>
                </div>

                <div class="field">
                  <div class="rating-row">
                    <label for="crgRating" class="rating-label">
                      CRG Rating
                      <span class="info-badge" tabindex="0" aria-label="Rating definitions">i</span>
                      <span class="info-pop">
                        Outperform (O): expected to materially outperform the sector average over a 12-month horizon.<br><br>
                        Sector Perform (SP): expected to perform broadly in line with the sector average over a 12-month horizon.<br><br>
                        Underperform (U): expected to materially underperform the sector average over a 12-month horizon.<br><br>
                        Restricted (R): assigned where CRG precludes the expression of an investment view due to Shariah considerations or ethical constraints.<br><br>
                        Not Rated (NR): no formal rating has been assigned.
                      </span>
                    </label>

                    <select id="crgRating" class="crg-rating-select">
                      <option value="" selected>Select rating...</option>
                      <option value="Outperform (O)">Outperform (O)</option>
                      <option value="Sector Perform (SP)">Sector Perform (SP)</option>
                      <option value="Underperform (U)">Underperform (U)</option>
                      <option value="Restricted (R)">Restricted (R)</option>
                      <option value="Not Rated (NR)">Not Rated (NR)</option>
                    </select>
                  </div>
                </div>
              </div>

              <!-- Price chart -->
              <div class="chart-panel">
                <div class="chart-head">
                  <div class="chart-title">Price chart</div>
                  <div class="chart-actions">
                    <select id="chartRange" class="chart-range">
                      <option value="6mo" selected>6M</option>
                      <option value="1y">1Y</option>
                      <option value="2y">2Y</option>
                      <option value="5y">5Y</option>
                    </select>
                    <button type="button" id="fetchPriceChart" class="btn btn-secondary">Fetch chart</button>
                  </div>
                </div>

                <div id="chartStatus" class="help-text" style="margin-top: 6px;"></div>

                <div class="chart-wrap">
                  <canvas id="priceChart" height="140"></canvas>
                </div>

                <div class="grid-2" style="margin-top: 14px;">
                  <div class="field">
                    <label for="targetPrice">Target price <span class="panel-muted">(Optional)</span></label>
                    <input type="text" id="targetPrice" placeholder="e.g., 520">
                  </div>

                  <div class="field">
                    <label>Snapshot</label>
                    <div class="metrics-grid">
                      <div class="metric-card">
                        <div class="metric-label">Current</div>
                        <div class="metric-value" id="currentPrice">â€”</div>
                      </div>
                      <div class="metric-card">
                        <div class="metric-label">Vol (ann.)</div>
                        <div class="metric-value" id="realisedVol">â€”</div>
                      </div>
                      <div class="metric-card">
                        <div class="metric-label">Range return</div>
                        <div class="metric-value" id="rangeReturn">â€”</div>
                      </div>
                      <div class="metric-card">
                        <div class="metric-label">Upside</div>
                        <div class="metric-value" id="upsideToTarget">â€”</div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>

              <!-- Model attachments -->
              <div class="field">
                <label for="modelFiles">Upload model files (Excel / PDF) <span class="panel-muted">(Optional)</span></label>
                <p class="help-text"><em>Tip: Upload the Excel model and any exported summary tabs as PDF so the note is auditable.</em></p>
                <input type="file" id="modelFiles" multiple accept=".xlsx,.xlsm,.xls,.csv,application/vnd.openxmlformats-officedocument.spreadsheetml.sheet,application/vnd.ms-excel,application/pdf">
                <div class="attachment-summary" id="attachmentSummary" aria-live="polite">
                  <div class="attachment-summary-head" id="attachmentSummaryHead">No files selected</div>
                  <div class="attachment-summary-list" id="attachmentSummaryList" style="display:none;"></div>
                </div>
              </div>

              <div class="field">
                <label for="modelLink">Model link (Drive / SharePoint) <span class="panel-muted">(Optional)</span></label>
                <input type="text" id="modelLink" placeholder="Paste a share link to the model">
              </div>

              <div class="field">
                <label for="valuationSummary">Valuation summary <span class="panel-muted">(Optional)</span></label>
                <textarea id="valuationSummary" rows="6" placeholder="Base-case FV, current price, implied upside/downside, and the main drivers."></textarea>
              </div>

              <div class="field">
                <label for="keyAssumptions">Key assumptions <span class="panel-muted">(Optional)</span></label>
                <textarea id="keyAssumptions" rows="7" placeholder="WACC, terminal growth, revenue CAGR, margins, tax, net debt, shares..."></textarea>
              </div>

              <div class="field">
                <label for="scenarioNotes">Scenario / sensitivity notes <span class="panel-muted">(Optional)</span></label>
                <textarea id="scenarioNotes" rows="5" placeholder="Bear/base/bull, what breaks the thesis, sensitivities."></textarea>
              </div>
            </div>
          </section>

          <!-- SECTION 4: Core research -->
          <section class="sec" id="sec-core" data-section="core">
            <div class="sec-head">
              <div class="sec-title">4) Core research</div>
              <div class="sec-subtitle">This is the â€œinstitutional bodyâ€: takeaways, analysis, and the Cordoba view.</div>
            </div>

            <div class="field">
              <label for="keyTakeaways">Key takeaways</label>
              <textarea id="keyTakeaways" rows="6" required placeholder="Use bullet points with - or * ..."></textarea>
              <div class="field-meta">
                <span class="meta-muted">Make them decision-useful. Avoid vague phrasing.</span>
                <span class="meta-right" id="ktCount">0 words</span>
              </div>
            </div>

            <div class="field">
              <label for="analysis">Analysis and commentary</label>
              <textarea id="analysis" rows="10" required placeholder="Write the full analysis, with data + risks."></textarea>
              <div class="field-meta">
                <span class="meta-muted">Aim: thesis â†’ evidence â†’ risk â†’ positioning.</span>
                <span class="meta-right" id="analysisCount">0 words</span>
              </div>
            </div>

            <div class="field">
              <label for="content">Additional content <span class="panel-muted">(Optional)</span></label>
              <textarea id="content" rows="8" placeholder="Appendices, deeper detail, scenario tables, background context..."></textarea>
              <div class="field-meta">
                <span class="meta-muted">Optional. Use for depth without bloating the main analysis.</span>
                <span class="meta-right" id="contentCount">0 words</span>
              </div>
            </div>

            <div class="field">
              <label for="cordobaView">The Cordoba view <span class="panel-muted">(Optional)</span></label>
              <textarea id="cordobaView" rows="6" placeholder="Your view, positioning, what youâ€™d do, and why."></textarea>
              <div class="field-meta">
                <span class="meta-muted">The â€œso whatâ€. Clear stance + conditions for change.</span>
                <span class="meta-right" id="cvCount">0 words</span>
              </div>
            </div>
          </section>

          <!-- SECTION 5: Attachments -->
          <section class="sec" id="sec-attachments" data-section="attachments">
            <div class="sec-head">
              <div class="sec-title">5) Figures & attachments</div>
              <div class="sec-subtitle">Upload charts/screenshots. Filenames become figure captions in the exported note.</div>
            </div>

            <div class="field">
              <label for="imageUpload">Upload images / graphs <span class="panel-muted">(Optional)</span></label>
              <p class="help-text"><em>Tip: Name files like â€œCPI_breakdown_UK.pngâ€ so captions are clean.</em></p>
              <input type="file" id="imageUpload" multiple accept="image/*">
              <div class="field-help">Figures are appended under â€œFigures and Chartsâ€.</div>
            </div>

            <div class="callout callout--warn">
              <div class="callout-title">Auditability</div>
              <div class="callout-text">If your conclusion depends on a model output, attach the model tab screenshot or a PDF export.</div>
            </div>
          </section>

          <!-- SECTION 6: Review & Export -->
          <section class="sec" id="sec-review" data-section="review">
            <div class="sec-head">
              <div class="sec-title">6) Review & export</div>
              <div class="sec-subtitle">Final checks before generating the Word document and emailing to the team.</div>
            </div>

            <div class="review-grid">
              <div class="review-card">
                <div class="review-card-title">Pre-flight checklist</div>
                <ul class="review-list">
                  <li>My title matches the thesis.</li>
                  <li>Key takeaways are actionable.</li>
                  <li>I stated risks / disconfirming evidence.</li>
                  <li>Figures or links support key claims.</li>
                  <li>Ticker and chart (if Equity) are correct.</li>
                </ul>

                <div class="review-confirm">
                  <label class="checkbox-row">
                    <input type="checkbox" id="confirmDraft">
                    <span>I confirm this is a draft research document for internal use and I will verify figures before circulation.</span>
                  </label>
                  <div class="field-help">Export is locked until this is checked.</div>
                </div>
              </div>

              <div class="review-card">
                <div class="review-card-title">Validation summary</div>
                <div class="validation-summary" id="validationSummary">
                  No issues detected.
                </div>
                <div class="field-help">Use â€œJump to first missingâ€ on the left if needed.</div>
              </div>
            </div>

            <div id="message" class="message"></div>
          </section>

          <!-- Sticky action bar -->
          <div class="actionbar">
            <div class="actionbar-left">
              <div class="actionbar-hint">
                Tip: <strong>Cmd/Ctrl + Enter</strong> generates the document.
              </div>
            </div>

            <div class="actionbar-right">
              <button type="button" id="emailToCrgBtn" class="btn btn-secondary">Email to CRG Research</button>
              <button type="button" id="resetFormBtn" class="btn btn-secondary">Reset</button>
              <button type="submit" class="btn btn-primary" id="generateBtn">Generate Word Document</button>
            </div>
          </div>

        </form>

        <!-- Institutional footer -->
        <div class="institutional-footer" aria-hidden="true">
          <div class="inst-version">RDT v1.1.0</div>
          <div class="inst-disclaimer">
            Internal use only. Outputs are draft research documentation generated from user inputs and third-party market data.
            This tool does not provide investment advice. Verify all figures, tickers, and assumptions before circulation.
          </div>
        </div>

      </main>
    </div>

  </div>

  <!-- External Libraries -->
  <script src="https://unpkg.com/docx@7.8.2/build/index.js"></script>
  <script src="https://unpkg.com/file-saver@2.0.5/dist/FileSaver.min.js"></script>

  <!-- Your JavaScript -->
  <script src="assets/app.js"></script>
</body>
</html>
